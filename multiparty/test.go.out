
package main

import (
	"os"
	"github.com/JoeyEremondi/GoSesh/dynamic"

)

//Higher order function: takes in a (possibly empty) map of addresses for channels
//Then returns the function which looks up the address for that channel (if it exists)
//And does the write
func makeChannelWriter(addrMap *map[dynamic.Channel]*net.Addr)(func(dynamic.Channel, []byte, net.Addr) (int, error)){
	return func(c dynamic.Channel, b []byte, addr net.Addr) (int, error){
		panic("TODO!")
	}
}

func makeChannelReader(addrMap *map[dynamic.Channel]*net.Addr)(func(dynamic.Channel, []byte) (int, net.Addr, error)){
	return func(c dynamic.Channel, b []byte) (int, net.Addr, error){
		panic("TODO!")
	}
}

func main(){
	argsWithoutProg := os.Args[1:]
	
if argsWithoutProg[1] == "--bar"{
	bar_main(argsWithoutProg[2:])
}
			
if argsWithoutProg[1] == "--foo"{
	foo_main(argsWithoutProg[2:])
}
			
}

func bar_main(args []string){
	var checker dynamic.Checker
	addrMap := make(map[dynamic.Channel]*net.Addr)
	addrMaker := func(c dynamic.Channel)net.Addr{return *addrMap[c]}
	readFun := makeChannelReader(&addrMap)
	writeFun := makeChannelWriter(&addrMap)
	
T:
for {
	
var recvBuf []byte
checker.ReadFrom("channel", readFun, recvBuf)
var receivedValue int
checker.UnpackReceive("TODO unpack message", recvBuf, &receivedValue)

var labelToSend = "isGood" //TODO which label to send
buf := checker.PrepareSend("TODO Select message", labelToSend)
checker.WriteTo("channel2", writeFun, buf, addrMaker)
switch labelToSend{
	
	case "isGood":
		return

			
	case "isBad":
		continue T

			
default:
	panic("Invalid label sent at selection choice")
}
		
	
}
		
}
			
func foo_main(args []string){
	var checker dynamic.Checker
	addrMap := make(map[dynamic.Channel]*net.Addr)
	addrMaker := func(c dynamic.Channel)net.Addr{return *addrMap[c]}
	readFun := makeChannelReader(&addrMap)
	writeFun := makeChannelWriter(&addrMap)
	
T:
for {
	
var sendArg int //TODO put a value here
sendBuf := checker.PrepareSend("TODO govec send message", sendArg)
checker.WriteTo("channel", writeFun, sendBuf, addrMaker)

var ourBuf []byte
checker.ReadFrom("channel2", readFun, ourBuf)
var receivedLabel string
checker.UnpackReceive("TODO Unpack Message", ourBuf, &receivedLabel)
switch receivedLabel{
	
	case "isGood":
		return

			
	case "isBad":
		continue T

			
default:
	panic("Invalid label sent at selection choice")
}
		
	
}
		
}
			
	